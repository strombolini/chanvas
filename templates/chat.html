{% extends "base.html" %}
{% block content %}
<div class="card">
  <div class="title">Chat with your files</div>
  <div id="extension-status" class="mut" style="margin-bottom:10px;"></div>
  <form id="chat-form" method="post" class="col">
    <div class="col">
      <label>Question</label>
      <textarea name="question" id="question-input" rows="4" placeholder="Ask about deadlines, grading policy, readings, announcements, etc." required>{{ question or "" }}</textarea>
    </div>
    <input type="hidden" name="canvas_data" id="canvas-data-input" />
    <input type="hidden" name="rag_index" id="rag-index-input" />
    <button class="btn mt" type="submit">Ask</button>
  </form>

  <script>
  (function() {
    let canvasDataCache = null;
    let ragIndexCache = null;
    const statusDiv = document.getElementById('extension-status');
    const form = document.getElementById('chat-form');
    const dataInput = document.getElementById('canvas-data-input');
    const ragInput = document.getElementById('rag-index-input');

    // Request data from extension on page load
    function requestExtensionData() {
      const requestId = Math.random().toString(36);

      return new Promise((resolve, reject) => {
        const timeout = setTimeout(() => {
          reject(new Error('Extension data request timed out'));
        }, 3000);

        function handleResponse(event) {
          if (event.data.type === 'CHANVAS_DATA_RESPONSE' && event.data.requestId === requestId) {
            clearTimeout(timeout);
            window.removeEventListener('message', handleResponse);
            resolve(event.data.data);
          }
        }

        window.addEventListener('message', handleResponse);
        window.postMessage({ type: 'CHANVAS_GET_DATA', requestId: requestId }, '*');
      });
    }

    // Request RAG index from extension
    function requestRAGIndex() {
      const requestId = Math.random().toString(36);

      return new Promise((resolve, reject) => {
        const timeout = setTimeout(() => {
          reject(new Error('RAG index request timed out'));
        }, 3000);

        function handleResponse(event) {
          if (event.data.type === 'CHANVAS_RAG_RESPONSE' && event.data.requestId === requestId) {
            clearTimeout(timeout);
            window.removeEventListener('message', handleResponse);
            resolve(event.data.ragIndex);
          }
        }

        window.addEventListener('message', handleResponse);
        window.postMessage({ type: 'CHANVAS_GET_RAG_INDEX', requestId: requestId }, '*');
      });
    }

    // Load data on page load
    Promise.all([requestExtensionData(), requestRAGIndex()]).then(([data, ragIndex]) => {
      if (data && data.courses) {
        canvasDataCache = data;
        const courseCount = Object.keys(data.courses).length;

        if (ragIndex && ragIndex.chunks && ragIndex.embeddings) {
          ragIndexCache = ragIndex;
          statusDiv.textContent = `âœ“ Extension loaded: ${courseCount} courses, ${ragIndex.chunks.length} indexed chunks (RAG enabled)`;
          statusDiv.style.color = '#28a745';
        } else {
          statusDiv.textContent = `âœ“ Extension loaded: ${courseCount} courses (RAG not indexed - will be slower)`;
          statusDiv.style.color = '#ffc107';
        }
      } else {
        statusDiv.textContent = 'âš  No course data found. Please scrape your Canvas courses first.';
        statusDiv.style.color = '#ffc107';
      }
    }).catch(err => {
      console.error('Failed to load extension data:', err);
      statusDiv.textContent = 'âœ— Extension not detected. Please install the Chanvas extension.';
      statusDiv.style.color = '#dc3545';
    });

    // Intercept form submission to include canvas data and RAG index
    form.addEventListener('submit', function(e) {
      if (canvasDataCache) {
        dataInput.value = JSON.stringify(canvasDataCache);
      }
      if (ragIndexCache) {
        ragInput.value = JSON.stringify(ragIndexCache);
      }
    });
  })();
  </script>

  {# --- INSERT A: Classes UI (buttons + mode) directly under the chat form --- #}
  {% if classes %}
  <div class="mt">
    <div class="title" style="font-size:18px">Your classes</div>

    <div class="mt" style="display:flex;align-items:center;gap:10px;">
      <label for="gen_mode" class="mut">Generate:</label>
      <select id="gen_mode">
        <option value="flashcards" {% if gen_mode == 'flashcards' %}selected{% endif %}>Flashcards</option>
        <option value="practice" {% if gen_mode == 'practice' %}selected{% endif %}>Practice problems</option>
      </select>
    </div>

    <div class="mt" id="class-buttons" style="display:flex;flex-wrap:wrap;gap:8px;">
      {% for c in classes %}
        <button class="btn class-btn" data-course="{{ c|e }}" type="button">{{ c }}</button>
      {% endfor %}
    </div>

    <form id="gen-form" method="post" class="hidden">
      <input type="hidden" name="gen_course" id="gen_course" />
      <input type="hidden" name="gen_mode" id="gen_mode_input" />
    </form>

    <script>
    (function() {
      const btns = document.querySelectorAll('.class-btn');
      const form = document.getElementById('gen-form');
      const courseInput = document.getElementById('gen_course');
      const modeSelect = document.getElementById('gen_mode');
      const modeInput = document.getElementById('gen_mode_input');
      btns.forEach(b => {
        b.addEventListener('click', function(ev) {
          ev.preventDefault();
          courseInput.value = this.dataset.course;
          modeInput.value = modeSelect.value;
          form.submit();
        });
      });
    })();
    </script>
  </div>
  {% endif %}
  {# --- END INSERT A --- #}

  {% if answer is not none %}
  <div class="mt">
    <div class="title" style="font-size:18px">Answer</div>
    <div id="answer" class="mono" style="white-space:pre-wrap;">{{ answer }}</div>
  </div>
  {% endif %}

  {% if chunks %}
  <div class="mt">
    <div class="title" style="font-size:18px">Context Used</div>
    <div class="mut">Using {{ chunks.count }} chunks ({{ chunks.total_chars }} characters)</div>
    <details class="mt">
      <summary style="cursor:pointer;color:var(--ocean-accent);">Show chunk preview</summary>
      <div style="margin-top:10px;">
        {% for chunk_text in chunks.chunks %}
          <div class="mut" style="margin-bottom:10px;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px;">
            [{{ loop.index }}] {{ chunk_text[:200] }}{% if chunk_text|length > 200 %}â€¦{% endif %}
          </div>
        {% endfor %}
      </div>
    </details>
  </div>
  {% endif %}

  {# --- INSERT B: Flashcards render --- #}
  {% if flashcards %}
  <div class="mt">
    <div class="title" style="font-size:18px">Flashcards â€” {{ selected_course }}</div>
    <div id="fc" class="card" style="text-align:center; cursor:pointer; min-height:140px; display:flex; align-items:center; justify-content:center;">
      <div id="fc-text"></div>
    </div>
    <div class="mut" style="margin-top:6px;">Click to flip; click again to advance.</div>
  </div>
  <script>
  (function(){
    const cards = {{ flashcards|tojson }};
    let i = 0, showBack = false;
    const box = document.getElementById('fc');
    const text = document.getElementById('fc-text');
    function render() {
      if (!cards || i >= cards.length) { text.textContent = "Done! ðŸŽ‰"; return; }
      const c = cards[i] || {};
      text.textContent = showBack ? (c.back || "") : (c.front || "");
    }
    box?.addEventListener('click', function() {
      if (!cards || i >= cards.length) return;
      if (!showBack) showBack = true; else { showBack = false; i += 1; }
      render();
    });
    render();
  })();
  </script>
  {% endif %}
  {# --- END INSERT B --- #}

  {# --- INSERT C: Practice test render (questions + answer key) --- #}
  {% if practice %}
  <div class="mt">
    <div class="title" style="font-size:18px">{{ practice.title or ("Practice Test â€” " ~ (selected_course or "")) }}</div>
    <ol>
      {% for q in practice.questions %}
        <li style="margin-bottom:10px;">{{ q.question }}</li>
      {% endfor %}
    </ol>
    <div class="mt">
      <div class="title" style="font-size:18px">Answer key</div>
      <ol>
        {% for q in practice.questions %}
          <li class="mut">{{ q.answer }}</li>
        {% endfor %}
      </ol>
    </div>
  </div>
  {% endif %}
  {# --- END INSERT C --- #}
</div>
{% endblock %}

